#!/bin/sh

usage() { 
cat << EOD
Usage:`basename $0`

    -t number of first volume
    -p volume prefix
EOD
}

if [ -f /qserv-deploy/config/volume_list.tfvars ]
then
    echo "Delete old volume_list file to continue and start over";
    exit; 
fi

CLUSTER_CONFIG_DIR=/qserv-deploy/config
# Check if openstack connection parameters are available
OS_RC_FILE="$CLUSTER_CONFIG_DIR/os-openrc.sh"
if [ -z "$OS_PROJECT_NAME" ]; then
    if [ -f "$OS_RC_FILE" ]; then
        . "$OS_RC_FILE"
    else
        echo "ERROR: Missing Openstack resource file: $OS_RC_FILE"
        exit 1
    fi
    if [ -z "$OS_PROJECT_NAME" ]; then
        echo "ERROR: Incorrect Openstack resource file: $OS_RC_FILE"
        exit 1
    fi
fi

while getopts ":t:p:m:" c; do
    case $c in
        t)
            t=${OPTARG} ;;
        p)
            p=${OPTARG} ;;
        m)
            m=${OPTARG} ;;
        \?)
            usage ; exit ;;
    esac
done
shift $((OPTIND-1))

if [ -z "${t}" ] || [ -z "${p}" ] || [ -z "${m}" ]; then
    usage ; exit ;
fi

echo "first volume = ${t}"
echo "volume prefix = ${p}"
echo "mount_point = ${m}"

volume_list=`openstack volume list -c ID -c Name -f csv | grep ${p} | awk -F\, '{ print $2";"$1 }' |tr , =`
volume_list=`echo ${volume_list} | sed -e 's/\"\ \"/\",\"/g' | sed -e "s/\${p}//g" | sed -e 's/;/=/g'`
volume_list={${volume_list}}

echo "# 1 if volumes must be attached, 0 otherwise" >>
$CLUSTER_CONFIG_DIR/volume_list.tfvars
echo "attach_volume=1" >> $CLUSTER_CONFIG_DIR/volume_list.tfvars

echo "# Number of first volume to attach" >>
$CLUSTER_CONFIG_DIR/volume_list.tfvars
echo "firstVolume = "$t >> $CLUSTER_CONFIG_DIR/volume_list.tfvars

echo "# Map of volume numbers and their ID" >>
$CLUSTER_CONFIG_DIR/volume_list.tfvars
echo "volumeId = "$volume_list >> $CLUSTER_CONFIG_DIR/volume_list.tfvars

echo "# Mount point of all volume" >> $CLUSTER_CONFIG_DIR/volume_list.tfvars
echo "mount_point = "$m >> $CLUSTER_CONFIG_DIR/volume_list.tfvars
